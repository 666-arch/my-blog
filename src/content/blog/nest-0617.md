---
author: Huang Chao
pubDatetime: 2024-06-16T09:06:22Z
modDatetime: 2024-02-16T09:46:56Z
title: "Nest框架 MySQL + TypeORM + JWT 实现登录注册"
featured: true
tags:
  - Nest
description: Nest - JWT 实现登录注册
---

## Mysql

创建个新的 database

```sql
CREATE SCHEMA login_test DEFAULT CHARACTER SET utf8mb4;
```

## 安装 typeorm 相关的包

```sql
npm install --save @nestjs/typeorm typeorm mysql2
```

## 在开始之前，首先明确什么是ORM？

- 简单来说就是数据库操作插件
- 提供反向配置数据库表，创建数据库连接池
- 例如，code first，这个概念第一次是从 `.net` 常用orm es 中了解到的，这里不做过多叙述
- 总之，就是可以自定义orm `class`，通过配置项，反向生成表，配置表字段，字段类型，主键等其他复杂操作

## AppModule

引入相关的 ORM库 TypeOrmModule，传入 option

```ts
import { Module } from "@nestjs/common";
import { AppController } from "./app.controller";
import { AppService } from "./app.service";
import { TypeOrmModule } from "@nestjs/typeorm";
import { UserModule } from "./user/user.module";
import { JwtModule } from "@nestjs/jwt";

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: "mysql",
      host: "localhost",
      port: 3306,
      username: "root",
      password: "your password",
      database: "login_test",
      synchronize: true,
      logging: true,
      entities: [],
    }),
    JwtModule.register({
      global: true,
      secret: "huang",
      signOptions: {
        expiresIn: "7d",
      },
    }),
    UserModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

这里主要是数据库配置项，通常只需要配置 `type`, `host`, `port`, `username`, `password`, `database`

```json lines
{
  "type": "mysql", //
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "your password",
  "database": "login_test",
  "synchronize": true,
  "logging": true,
  "entities": []
}
```

现在给 Nest 快速创建一个 User 的 CRUD 模块

```sql
nest g resource user
```

随即在 `app.module.ts` 中引入 User 的 `Entity`

```ts
import { User } from "./user/entities/user.entity";
entities: [User];
```

## Entity 实体类

- 映射到数据库表，配置并且生成数据库表字段，属性的基础类，可以自定义字段类型，字段名称等
- 给 User Entity 添加一些属性，详情可见 https://typeorm.bootcss.com/entities
- PrimaryGeneratedColumn 自动增量的主键值，如果需要用到 uuid 生成 `PrimaryGeneratedColumn("uuid")`
- 这里的 @CreateDateColumn 和 @UpdateDateColumn 都是 `datetime` 类型。

```ts
import {
  Column,
  CreateDateColumn,
  Entity,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from "typeorm";

@Entity() //标记表明这是一个实体类
export class User {
  @PrimaryGeneratedColumn() //默认 int 自增
  id: number;

  @Column({
    length: 50,
    comment: "用户名",
  })
  username: string;

  @Column({
    length: 50,
    comment: "密码",
  })
  password: string;

  @CreateDateColumn({
    comment: "创建时间",
  })
  createTime: Date;

  @UpdateDateColumn({
    comment: "更新时间",
  })
  updateTime: Date;
}
```

然后跑下服务

```sql
npm run start:dev
```

![0616.png](../../assets/images/0616.png)
